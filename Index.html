<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Momentum</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        :root {
            --primary-color: #007aff; /* iOS Blue */
            --secondary-color: #34c759; /* iOS Green */
            --tertiary-color: #ff9500; /* iOS Orange */
            --background-color: #f2f2f7; /* iOS Light Gray Background */
            --card-background: #ffffff;
            --text-color: #000000;
            --secondary-text-color: #8e8e93;
            --border-color: #c6c6c8;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --spacing-unit: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        #app-container {
            flex-grow: 1;
            padding-bottom: 70px; /* Space for the bottom nav */
            overflow-y: auto;
        }

        .page-section {
            padding: var(--spacing-unit);
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* iOS-style Card */
        .card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-unit);
            padding: var(--spacing-unit);
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: transform 0.1s ease-out;
        }

        .card-header {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: var(--spacing-unit);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Navigation Bar */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 65px;
            background-color: var(--card-background);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -1px 3px var(--shadow-color);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 10px;
            cursor: pointer;
            color: var(--secondary-text-color);
            font-size: 0.7em;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 3px;
        }

        /* Timer List and Controls */
        #timers-list .card {
            padding: 12px var(--spacing-unit);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timer-category-name {
            font-weight: 600;
            flex-grow: 1;
            font-size: 1.1em;
        }

        .timer-controls {
            display: flex;
            gap: 8px;
        }

        .timer-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.1s;
        }

        .btn-start { background-color: var(--secondary-color); color: white; }
        .btn-stop { background-color: #ff3b30; /* iOS Red */ color: white; }
        .btn-log { background-color: var(--tertiary-color); color: white; }
        .btn-delete { background-color: var(--border-color); color: var(--text-color); }
        .btn-add { background-color: var(--primary-color); color: white; width: 100%; }

        .btn-start:active, .btn-stop:active, .btn-log:active, .btn-delete:active, .btn-add:active {
            filter: brightness(0.9);
        }

        /* Progress Bar */
        #daily-goal-progress {
            margin-top: var(--spacing-unit);
            height: 10px;
            background-color: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--primary-color);
            transition: width 0.3s ease-out;
        }

        /* Notes Page */
        #note-textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            margin-bottom: 10px;
            font-size: 1em;
            resize: none;
        }

        .note-card {
            border-left: 5px solid var(--primary-color);
            padding: 10px;
        }

        .note-card-date {
            font-weight: 600;
            color: var(--secondary-text-color);
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .note-card-content {
            white-space: pre-wrap;
        }

        /* Home Page */
        .home-summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .home-summary-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .summary-name {
            font-weight: 500;
        }

        .summary-time {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Data Management */
        .data-management-controls {
            display: flex;
            gap: var(--spacing-unit);
            margin-top: var(--spacing-unit);
        }
        
        .data-management-controls > button, #import-file-input {
            flex: 1;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--primary-color);
            background-color: transparent;
            color: var(--primary-color);
            transition: background-color 0.1s, color 0.1s;
        }

        .data-management-controls > button:hover {
            background-color: var(--primary-color);
            color: white;
        }

        #import-file-input {
            display: none;
        }

        .file-upload-label {
            flex: 1;
            display: block;
            text-align: center;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--primary-color);
            background-color: transparent;
            color: var(--primary-color);
            transition: background-color 0.1s, color 0.1s;
        }

        .file-upload-label:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Utility */
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="app-container">
        <section id="home-page" class="page-section active">
            <h1 class="text-center" style="font-size: 2em; margin-bottom: var(--spacing-unit);">Momentum</h1>

            <div class="card">
                <div class="card-header">Today's Total: <span id="today-total-time" style="color: var(--primary-color);">0h 0m</span></div>
                <div id="daily-categories-list">
                    </div>
            </div>

            <div class="card">
                <div class="card-header">Daily Breakdown</div>
                <div class="text-center">
                    <canvas id="daily-donut-chart" style="max-height: 250px;"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Weekly Performance (Minutes)</div>
                <div class="text-center">
                    <canvas id="weekly-line-chart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </section>

        <section id="timers-page" class="page-section">
            <h2 class="text-center" style="color: var(--secondary-text-color); margin-bottom: var(--spacing-unit);">Active: <span id="active-timer-display" style="color: var(--primary-color);">None</span></h2>
            
            <div class="card">
                <div class="card-header">Daily Goal Progress (6 Hours)</div>
                <div id="daily-goal-progress">
                    <div id="progress-bar"></div>
                </div>
                <p style="font-size: 0.9em; margin-top: 5px;">Goal: 6h 0m | Done: <span id="progress-done-time">0m</span></p>
            </div>

            <div class="card">
                <div class="card-header">Timer Categories</div>
                <div id="timers-list">
                    </div>
                <button class="timer-btn btn-add" id="add-category-btn" style="margin-top: var(--spacing-unit);">+ Add New Category</button>
            </div>

            <div class="card">
                <div class="card-header">Data Management</div>
                <div class="data-management-controls">
                    <button id="export-data-btn">Export Data (JSON)</button>
                    <input type="file" id="import-file-input" accept="application/json">
                    <label for="import-file-input" class="file-upload-label">Import Data (JSON)</label>
                </div>
            </div>
        </section>

        <section id="notes-page" class="page-section">
            <div class="card">
                <div class="card-header">Today's Note</div>
                <textarea id="note-textarea" placeholder="What did you do today?"></textarea>
                <button class="timer-btn btn-start" id="save-note-btn" style="width: 100%;">Save Note</button>
            </div>

            <div class="card">
                <div class="card-header">Previous Notes</div>
                <div id="previous-notes-list">
                    </div>
            </div>
        </section>
    </div>

    <nav id="bottom-nav">
        <div class="nav-item active" data-page="home-page">
            <span class="nav-icon">üè†</span>
            <span>Home</span>
        </div>
        <div class="nav-item" data-page="timers-page">
            <span class="nav-icon">‚è±Ô∏è</span>
            <span>Timers</span>
        </div>
        <div class="nav-item" data-page="notes-page">
            <span class="nav-icon">üìù</span>
            <span>Notes</span>
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // --- Service Worker and Manifest Setup ---
        const manifestContent = {
            name: "Momentum",
            short_name: "Momentum",
            description: "A simple, offline, mobile-first performance tracker.",
            start_url: "/",
            display: "standalone",
            background_color: "#f2f2f7",
            theme_color: "#007aff",
            icons: [
                {
                    src: "/icon-192.png",
                    sizes: "192x192",
                    type: "image/png"
                },
                {
                    src: "/icon-512.png",
                    sizes: "512x512",
                    type: "image/png"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifestContent)], { type: 'application/json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').setAttribute('href', manifestUrl);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
self.addEventListener('install', event => {
    event.waitUntil(
        caches.open('momentum-cache-v1').then(cache => {
            return cache.addAll([
                '/',
                'index.html',
                'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js'
            ]);
        })
    );
});

self.addEventListener('fetch', event => {
    event.respondWith(
        caches.match(event.request).then(response => {
            return response || fetch(event.request);
        })
    );
});
`;
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);

                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('SW registered!', reg))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
        
        // --- Core State and LocalStorage ---
        const LS_KEY_SESSIONS = 'momentum_sessions';
        const LS_KEY_CATEGORIES = 'momentum_categories';
        const LS_KEY_NOTES = 'momentum_notes';
        const DAILY_GOAL_MINUTES = 6 * 60; // 6 hours in minutes
        
        let categories = [];
        let sessions = [];
        let notes = {};
        let activeTimer = null;
        let timerInterval = null;

        const dateToYMD = (date) => date.toISOString().split('T')[0];

        function loadData() {
            try {
                categories = JSON.parse(localStorage.getItem(LS_KEY_CATEGORIES)) || [
                    { id: 'study', name: 'Study', color: '#007aff' },
                    { id: 'project', name: 'Project', color: '#34c759' },
                    { id: 'workout', name: 'Workout', color: '#ff9500' },
                    { id: 'social', name: 'Social', color: '#ff3b30' }
                ];
                sessions = JSON.parse(localStorage.getItem(LS_KEY_SESSIONS)) || [];
                notes = JSON.parse(localStorage.getItem(LS_KEY_NOTES)) || {};
            } catch (e) {
                console.error("Error loading data from LocalStorage:", e);
                // Reset to defaults if parsing fails
                categories = [
                    { id: 'study', name: 'Study', color: '#007aff' },
                    { id: 'project', name: 'Project', color: '#34c759' },
                    { id: 'workout', name: 'Workout', color: '#ff9500' },
                    { id: 'social', name: 'Social', color: '#ff3b30' }
                ];
                sessions = [];
                notes = {};
            }
        }

        function saveData() {
            localStorage.setItem(LS_KEY_CATEGORIES, JSON.stringify(categories));
            localStorage.setItem(LS_KEY_SESSIONS, JSON.stringify(sessions));
            localStorage.setItem(LS_KEY_NOTES, JSON.stringify(notes));
        }

        // --- Utility Functions ---

        function formatMinutes(totalMinutes) {
            const h = Math.floor(totalMinutes / 60);
            const m = Math.round(totalMinutes % 60);
            return `${h}h ${m}m`;
        }

        function getTodaySessions() {
            const today = dateToYMD(new Date());
            return sessions.filter(s => s.date === today);
        }

        function getWeeklySessions() {
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const oneWeekAgoYMD = dateToYMD(oneWeekAgo);

            return sessions.filter(s => s.date >= oneWeekAgoYMD);
        }

        function getMinutesByCategory(sessionsList) {
            return sessionsList.reduce((acc, session) => {
                acc[session.category_id] = (acc[session.category_id] || 0) + session.minutes;
                return acc;
            }, {});
        }

        function calculateDailyTotalMinutes() {
            return getTodaySessions().reduce((total, session) => total + session.minutes, 0);
        }

        // --- Navigation ---
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                const targetPage = this.dataset.page;
                
                document.querySelectorAll('.page-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(targetPage).classList.add('active');

                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
                this.classList.add('active');

                if (targetPage === 'home-page') {
                    renderHome();
                } else if (targetPage === 'timers-page') {
                    renderTimers();
                } else if (targetPage === 'notes-page') {
                    renderNotes();
                }
            });
        });

        // --- HOME PAGE (Rendering & Charts) ---

        let donutChart = null;
        let lineChart = null;
        
        function renderHome() {
            const todaySessions = getTodaySessions();
            const totalMinutes = calculateDailyTotalMinutes();
            document.getElementById('today-total-time').textContent = formatMinutes(totalMinutes);

            const categoryMinutes = getMinutesByCategory(todaySessions);
            const categoryData = categories.map(cat => ({
                name: cat.name,
                minutes: categoryMinutes[cat.id] || 0,
                color: cat.color
            })).filter(data => data.minutes > 0).sort((a, b) => b.minutes - a.minutes);
            
            // Render Categories List
            const listHtml = categoryData.map(data => `
                <div class="home-summary-item">
                    <span class="summary-name" style="color: ${data.color};">${data.name}</span>
                    <span class="summary-time">${formatMinutes(data.minutes)}</span>
                </div>
            `).join('');
            document.getElementById('daily-categories-list').innerHTML = listHtml || '<p style="text-align: center; color: var(--secondary-text-color);">No activity recorded today.</p>';

            // Render Donut Chart
            if (donutChart) donutChart.destroy();
            donutChart = new Chart(document.getElementById('daily-donut-chart'), {
                type: 'doughnut',
                data: {
                    labels: categoryData.map(d => d.name),
                    datasets: [{
                        data: categoryData.map(d => d.minutes),
                        backgroundColor: categoryData.map(d => d.color),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { callbacks: { label: (context) => `${context.label}: ${formatMinutes(context.parsed)}` } }
                    }
                }
            });

            // Render Line Chart
            const weeklySessions = getWeeklySessions();
            const weeklyData = {}; // { YYYY-MM-DD: total_minutes }
            weeklySessions.forEach(s => {
                weeklyData[s.date] = (weeklyData[s.date] || 0) + s.minutes;
            });

            const labels = [];
            const data = [];
            let currentDate = new Date();
            for (let i = 6; i >= 0; i--) {
                const day = new Date(currentDate.getTime() - i * 24 * 60 * 60 * 1000);
                const dayYMD = dateToYMD(day);
                labels.push(day.toLocaleDateString('en-US', { weekday: 'short' }));
                data.push(weeklyData[dayYMD] || 0);
            }

            if (lineChart) lineChart.destroy();
            lineChart = new Chart(document.getElementById('weekly-line-chart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Minutes Worked',
                        data: data,
                        borderColor: var('--primary-color'),
                        backgroundColor: 'rgba(0, 122, 255, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Minutes' } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (context) => `Total: ${formatMinutes(context.parsed.y)}` } }
                    }
                }
            });
        }


        // --- TIMERS PAGE (Rendering & Logic) ---

        function renderTimers() {
            const timersListEl = document.getElementById('timers-list');
            timersListEl.innerHTML = ''; // Clear existing list

            categories.forEach(cat => {
                const isActive = activeTimer && activeTimer.category_id === cat.id;
                const timerMinutes = isActive ? Math.floor((Date.now() - activeTimer.start_time) / 60000) : 0;
                const displayTime = isActive ? `(${formatMinutes(timerMinutes)})` : '';
                
                const card = document.createElement('div');
                card.classList.add('card');
                card.dataset.id = cat.id;

                card.innerHTML = `
                    <div class="timer-category-name" style="color: ${cat.color};">${cat.name} ${displayTime}</div>
                    <div class="timer-controls">
                        <button class="timer-btn ${isActive ? 'btn-stop' : 'btn-start'}" data-action="${isActive ? 'stop' : 'start'}">${isActive ? 'Stop' : 'Start'}</button>
                        <button class="timer-btn btn-log" data-action="log">Log</button>
                        <button class="timer-btn btn-delete" data-action="delete">X</button>
                    </div>
                `;
                timersListEl.appendChild(card);
            });

            updateProgress();
            updateActiveTimerDisplay();
        }

        function updateProgress() {
            const todayTotalMinutes = calculateDailyTotalMinutes();
            const doneTimeEl = document.getElementById('progress-done-time');
            const progressBarEl = document.getElementById('progress-bar');
            
            doneTimeEl.textContent = formatMinutes(todayTotalMinutes);

            let progressPercentage = (todayTotalMinutes / DAILY_GOAL_MINUTES) * 100;
            if (progressPercentage > 100) progressPercentage = 100;

            progressBarEl.style.width = `${progressPercentage}%`;
        }

        function updateActiveTimerDisplay() {
            const activeDisplayEl = document.getElementById('active-timer-display');
            if (activeTimer) {
                const cat = categories.find(c => c.id === activeTimer.category_id);
                const elapsedMinutes = Math.floor((Date.now() - activeTimer.start_time) / 60000);
                activeDisplayEl.textContent = `${cat.name} (${formatMinutes(elapsedMinutes)})`;
            } else {
                activeDisplayEl.textContent = 'None';
            }
        }

        function startTimer(categoryId) {
            if (activeTimer) {
                stopTimer(activeTimer.category_id, true); // Stop any existing timer first
            }

            activeTimer = {
                category_id: categoryId,
                start_time: Date.now()
            };

            timerInterval = setInterval(() => {
                updateActiveTimerDisplay();
                if (document.getElementById('timers-page').classList.contains('active')) {
                     renderTimers(); // Force refresh to show current timer minutes
                }
            }, 5000); // Update every 5 seconds for live display

            renderTimers();
        }

        function stopTimer(categoryId, isSwitch = false) {
            if (!activeTimer || activeTimer.category_id !== categoryId) return;

            clearInterval(timerInterval);
            timerInterval = null;

            const elapsedMinutes = Math.floor((Date.now() - activeTimer.start_time) / 60000);
            activeTimer = null;

            if (elapsedMinutes > 0) {
                addSession(categoryId, elapsedMinutes);
                if (!isSwitch) {
                    alert(`Logged ${formatMinutes(elapsedMinutes)} for ${categories.find(c => c.id === categoryId).name}.`);
                }
            } else if (!isSwitch) {
                alert("Less than a minute recorded. Session cancelled.");
            }

            renderTimers();
            renderHome();
        }

        function addSession(categoryId, minutes) {
            sessions.push({
                date: dateToYMD(new Date()),
                category_id: categoryId,
                minutes: minutes,
                timestamp: Date.now()
            });
            saveData();
            updateProgress();
        }

        document.getElementById('timers-list').addEventListener('click', (e) => {
            const btn = e.target.closest('.timer-btn');
            if (!btn) return;
            
            const action = btn.dataset.action;
            const categoryId = btn.closest('.card').dataset.id;
            const categoryName = categories.find(c => c.id === categoryId).name;

            if (action === 'start') {
                startTimer(categoryId);
            } else if (action === 'stop') {
                stopTimer(categoryId);
            } else if (action === 'log') {
                const minutesStr = prompt(`Enter minutes to log for ${categoryName}:`);
                const minutes = parseInt(minutesStr);
                if (minutes > 0) {
                    addSession(categoryId, minutes);
                    alert(`Logged ${minutes} minutes for ${categoryName}.`);
                    renderTimers();
                    renderHome();
                } else if (minutesStr !== null) {
                    alert("Invalid minutes entered.");
                }
            } else if (action === 'delete') {
                if (confirm(`Are you sure you want to delete the category "${categoryName}" and all associated sessions?`)) {
                    categories = categories.filter(c => c.id !== categoryId);
                    sessions = sessions.filter(s => s.category_id !== categoryId);
                    if (activeTimer && activeTimer.category_id === categoryId) {
                        stopTimer(categoryId);
                    }
                    saveData();
                    renderTimers();
                    renderHome();
                }
            }
        });

        document.getElementById('add-category-btn').addEventListener('click', () => {
            const newName = prompt("Enter new category name:");
            if (newName) {
                const newId = newName.toLowerCase().replace(/\s/g, '_');
                if (categories.some(c => c.id === newId)) {
                    alert("A category with this name already exists (or its slug does).");
                    return;
                }
                const newColor = `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`;
                categories.push({ id: newId, name: newName, color: newColor });
                saveData();
                renderTimers();
            }
        });

        // --- NOTES PAGE (Rendering & Logic) ---

        function renderNotes() {
            const today = dateToYMD(new Date());
            const previousNotesListEl = document.getElementById('previous-notes-list');
            previousNotesListEl.innerHTML = '';
            
            document.getElementById('note-textarea').value = notes[today] || '';

            const sortedDates = Object.keys(notes)
                .filter(d => d !== today)
                .sort((a, b) => new Date(b) - new Date(a));

            if (sortedDates.length === 0) {
                 previousNotesListEl.innerHTML = '<p style="text-align: center; color: var(--secondary-text-color);">No previous notes.</p>';
                 return;
            }

            sortedDates.forEach(dateStr => {
                const noteCard = document.createElement('div');
                noteCard.classList.add('card', 'note-card');
                noteCard.innerHTML = `
                    <div class="note-card-date">${new Date(dateStr).toLocaleDateString()}</div>
                    <div class="note-card-content">${notes[dateStr]}</div>
                `;
                previousNotesListEl.appendChild(noteCard);
            });
        }

        document.getElementById('save-note-btn').addEventListener('click', () => {
            const today = dateToYMD(new Date());
            const noteText = document.getElementById('note-textarea').value.trim();
            
            if (noteText) {
                notes[today] = noteText;
                alert("Note saved!");
            } else {
                delete notes[today];
                alert("Note cleared.");
            }
            saveData();
            renderNotes();
        });


        // --- Data Import/Export ---

        document.getElementById('export-data-btn').addEventListener('click', () => {
            const data = {
                categories: categories,
                sessions: sessions,
                notes: notes,
                export_date: new Date().toISOString()
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `momentum_data_${dateToYMD(new Date())}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.getElementById('import-file-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.categories && importedData.sessions && importedData.notes) {
                        if (confirm("Importing data will overwrite your current categories, sessions, and notes. Continue?")) {
                            categories = importedData.categories;
                            sessions = importedData.sessions;
                            notes = importedData.notes;
                            saveData();
                            alert("Data imported successfully! The app will now reload.");
                            window.location.reload();
                        }
                    } else {
                        alert("Invalid file format. Missing categories, sessions, or notes.");
                    }
                } catch (error) {
                    alert("Failed to parse JSON file.");
                    console.error("Import error:", error);
                }
            };
            reader.readAsText(file);
            document.getElementById('import-file-input').value = null; // Reset input
        });

        // --- Initialization ---
        loadData();
        renderHome(); // Start on the Home page
        
    </script>
</body>
</html>
      <section class="card hero">
        <div class="hero-top">
          <div>
            <div class="muted">Today's total</div>
            <div class="today-total" id="todayTotal">0m</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Streak</div>
            <div style="font-weight:800" id="streak">0d</div>
          </div>
        </div>

        <div class="chip-row" id="chipRow"></div>

        <div class="charts-stack">
          <div class="chart-card">
            <div class="chart-title"><strong>Daily Distribution</strong><span class="muted">Breakdown</span></div>
            <div class="chart-wrap">
              <canvas id="donutChart"></canvas>
              <div id="donutCenter" class="donut-center">0h</div>
            </div>
            <div id="donutLegend" style="margin-top:10px"></div>
          </div>

          <div class="chart-card">
            <div class="chart-title"><strong>Weekly Trend</strong><span class="muted" id="weekRange">‚Äî</span></div>
            <div class="chart-wrap"><canvas id="lineChart"></canvas></div>
          </div>
        </div>

        <div class="sessions">
          <div style="margin-top:10px" class="muted">Recent sessions</div>
          <div id="sessionsList" style="margin-top:8px"></div>
        </div>
      </section>
    </main>

    <main id="page-timers" class="page" style="display:none">
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Timers</strong><div class="muted">Start sessions and hit goals</div></div>
          <div style="display:flex;gap:8px">
            <button class="btn" id="btnAdd">+ Add</button>
            <button class="btn" id="btnDefaults">Defaults</button>
          </div>
        </div>
        <div class="timers-list" id="timersList"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div class="muted">Clear today's sessions if needed</div>
          <button class="btn" id="btnClearToday">Clear Today</button>
        </div>
      </section>
    </main>

    <main id="page-notes" class="page" style="display:none">
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Notes</strong><div class="muted">Write what you achieved today</div></div>
          <div class="muted" id="notesDate">‚Äî</div>
        </div>

        <div style="margin-top:12px">
          <textarea id="noteText" placeholder="What you achieve today..."></textarea>
          <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" id="saveNote">Save</button></div>
        </div>

        <div style="margin-top:14px">
          <div class="muted">Previous notes</div>
          <div class="notes-list" id="notesList"></div>
        </div>
      </section>
    </main>

    <footer style="text-align:center;color:var(--muted);font-size:12px;margin-top:6px">Offline ‚Ä¢ Single file ‚Ä¢ LocalStorage</footer>
  </div>
</div>

<div class="bottom-nav">
  <div class="nav-wrap">
    <div class="nav-item" data-page="home">
      <button class="nav-btn nav-active" id="navHome">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="8" stroke="#0B69FF" stroke-width="1.6"/><circle cx="12" cy="12" r="4" fill="#0B69FF"/></svg>
        <div class="nav-label">Home</div>
      </button>
    </div>

    <div class="nav-item" data-page="timers">
      <button class="nav-btn" id="navTimers">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none"><path d="M12 7v6l4 2" stroke="#9CA3AF" stroke-width="1.6" stroke-linecap="round"/><circle cx="12" cy="12" r="8" stroke="#9CA3AF" stroke-width="1.6"/></svg>
        <div class="nav-label">Timers</div>
      </button>
    </div>

    <div class="nav-item" data-page="notes">
      <button class="nav-btn" id="navNotes">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none"><rect x="4" y="4" width="16" height="16" rx="2" stroke="#9CA3AF" stroke-width="1.6"/><path d="M8 8h8M8 12h8M8 16h5" stroke="#9CA3AF" stroke-width="1.6"/></svg>
        <div class="nav-label">Notes</div>
      </button>
    </div>
  </div>
</div>

<script>
const uid = (n=8)=>Math.random().toString(36).slice(2,2+n);
const fmt = s=>{if(!s)return'0m';if(s<60)return Math.round(s)+'s';const h=Math.floor(s/3600),m=Math.floor((s%3600)/60);if(h)return`${h}h ${m}m`;return`${m}m`};
const dayKey = d=>d.toISOString().slice(0,10);

const KEY='momentum.mobile.final';
let state={categories:{},sessions:[],notes:{},createdAt:Date.now()};
function save(){localStorage.setItem(KEY,JSON.stringify(state))}
function load(){try{const r=localStorage.getItem(KEY);if(r)state=JSON.parse(r)}catch(e){}}
load();

function ensureDefaults(){
  if(Object.keys(state.categories).length)return;
  addCategory('Study',6);addCategory('Project',4);addCategory('Workout',1);addCategory('Social',0.5);
  save();
}

function addCategory(name,hours=1){
  const id=uid(6);state.categories[id]={id,name,goalSeconds:Math.round(hours*3600),running:false,currentStart:null};
  save();renderAll();return id;
}
function removeCategory(id){
  delete state.categories[id];
  state.sessions=state.sessions.filter(s=>s.catId!==id);
  save();renderAll();
}

function startTimer(id){
  Object.values(state.categories).forEach(c=>{if(c.running)stopTimer(c.id)});
  const c=state.categories[id];if(!c)return;
  c.running=true;c.currentStart=Date.now();save();renderAll();startTicker();
}
function stopTimer(id,note=''){
  const c=state.categories[id];if(!c||!c.running)return;
  const start=c.currentStart||Date.now();const stop=Date.now();
  const dur=Math.round((stop-start)/1000);
  c.running=false;c.currentStart=null;
  state.sessions.push({id:uid(8),catId:id,start,stop,duration:dur,date:dayKey(new Date(start)),notes:note});
  save();renderAll();
}
function addManual(id,minutes){
  const dur=Math.round(minutes*60),start=Date.now()-dur*1000;
  state.sessions.push({id:uid(8),catId:id,start,stop:Date.now(),duration:dur,date:dayKey(new Date(start)),notes:'manual'});
  save();renderAll();
}
function clearToday(){
  const t=dayKey(new Date());
  state.sessions=state.sessions.filter(s=>s.date!==t);
  if(state.notes)delete state.notes[t];
  save();renderAll();
}

function totalForDate(d){return state.sessions.filter(s=>s.date===d).reduce((a,b)=>a+b.duration,0)}
function totalForCatDate(catId,d){return state.sessions.filter(s=>s.catId===catId&&s.date===d).reduce((a,b)=>a+b.duration,0)}
function lastNDays(n=7,end=new Date()){const out=[];for(let i=n-1;i>=0;i--){const dt=new Date(end);dt.setDate(dt.getDate()-i);out.push(dayKey(dt))}return out;}

const pageHome=document.getElementById('page-home');
const pageTimers=document.getElementById('page-timers');
const pageNotes=document.getElementById('page-notes');

const todayTotalEl=document.getElementById('todayTotal');
const streakEl=document.getElementById('streak');
const chipRow=document.getElementById('chipRow');
const sessionsList=document.getElementById('sessionsList');
const donutCanvas=document.getElementById('donutChart');
const donutCenter=document.getElementById('donutCenter');
const lineCanvas=document.getElementById('lineChart');
const timersList=document.getElementById('timersList');
const notesList=document.getElementById('notesList');
const noteText=document.getElementById('noteText');
const notesDate=document.getElementById('notesDate');
const weekRangeEl=document.getElementById('weekRange');

let donutChart=null,lineChart=null;

const DonutCenter={
  id:'donutCenterDisplay',
  afterDraw(chart){
    if(chart.config.type!=='doughnut')return;
    const text=chart.config.options.plugins.centerText.text;
    const{ctx,chartArea:{left,top,width,height}}=chart;
    ctx.save();ctx.fillStyle='#071022';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.font='700 16px Inter';ctx.fillText(text,left+width/2,top+height/2);ctx.restore();
  }
};
Chart.register(DonutCenter);

function renderDonut(){
  const today=dayKey(new Date());
  const catIds=Object.keys(state.categories);
  const labels=catIds.map(id=>state.categories[id].name);
  const data=catIds.map(id=>Math.round(totalForCatDate(id,today)/60));
  const totalMin=data.reduce((a,b)=>a+b,0);
  donutCenter.innerText=totalMin?`${Math.round(totalMin/60)}h ${totalMin%60}m`:'0h';

  const legend=document.getElementById('donutLegend');
  legend.innerHTML='';
  const colors=['#0b69ff','#13a45a','#ff8a3d','#06b6d4','#7c5cff','#f973a5'];
  labels.forEach((lab,i)=>{
    const minutes=data[i];
    const pct=totalMin?Math.round((minutes/totalMin)*100):0;
    const hr=Math.floor(minutes/60);const mn=minutes%60;
    const row=document.createElement('div');
    row.style.display='flex';row.style.alignItems='center';row.style.gap='10px';row.style.marginTop='6px';
    row.innerHTML=`<div style="width:12px;height:12px;background:${colors[i%colors.length]};border-radius:3px"></div><div style="flex:1"><strong>${lab}</strong></div><div style="color:#6b7280">${hr}h ${mn}m, ${pct}%</div>`;
    legend.appendChild(row);
  });

  if(donutChart)donutChart.destroy();
  donutChart=new Chart(donutCanvas,{
    type:'doughnut',
    data:{labels,datasets:[{data,backgroundColor:labels.map((_,i)=>colors[i%colors.length])}]},
    options:{
      responsive:true,maintainAspectRatio:false,cutout:'62%',
      plugins:{legend:{display:false},centerText:{text:totalMin?`${Math.round(totalMin/60)}h ${totalMin%60}m`:'0h'}}
    }
  });
}

function renderLine(){
  const days=lastNDays(7);
  weekRangeEl.innerText=`${days[0]} ‚Üí ${days[6]}`;
  const labels=days.map(d=>d.slice(5));
  const mins=days.map(d=>Math.round(totalForDate(d)/60));
  const hours=mins.map(m=>(m/60).toFixed(2));

  if(lineChart)lineChart.destroy();
  lineChart=new Chart(lineCanvas,{
    type:'line',
    data:{labels,
      datasets:[{
        label:'Hours',
        data:hours,
        borderColor:'#0b69ff',
        backgroundColor:ctx=>{
          const g=ctx.chart.ctx.createLinearGradient(0,0,0,ctx.chart.height);
          g.addColorStop(0,'rgba(11,105,255,0.18)');
          g.addColorStop(1,'rgba(11,105,255,0.02)');
          return g;
        },
        fill:true,tension:.36,pointRadius:5,pointBackgroundColor:'#fff',pointBorderColor:'#0b69ff'
      }]},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`${ctx.parsed.y}h`}}},
      scales:{
        x:{grid:{display:false},ticks:{color:'#6b7280'}},
        y:{grid:{color:'rgba(7,16,34,0.04)'},ticks:{callback:v=>v+'h',color:'#6b7280'},beginAtZero:true}
      }
    }
  });
}

function renderHome(){
  const today=dayKey(new Date());
  const tot=totalForDate(today);
  todayTotalEl.innerText=fmt(tot);

  const days=lastNDays(30);let streak=0;
  for(let i=29;i>=0;i--){if(totalForDate(days[i])>600)streak++;else break;}
  streakEl.innerText=streak+'d';

  chipRow.innerHTML='';
  Object.values(state.categories).forEach(c=>{
    const sec=totalForCatDate(c.id,today);
    const div=document.createElement('div');div.className='chip';
    div.innerHTML=`<div style="font-weight:800">${c.name}</div><small>${fmt(sec)}</small>`;
    chipRow.appendChild(div);
  });

  sessionsList.innerHTML='';
  const recent=state.sessions.slice().reverse().slice(0,8);
  recent.forEach(s=>{
    const cat=state.categories[s.catId]?state.categories[s.catId].name:'Unknown';
    const when=new Date(s.start).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const el=document.createElement('div');el.className='session';
    el.innerHTML=`<div><strong>${cat}</strong> <small>‚Ä¢ ${fmt(s.duration)}</small></div><div><small class="muted">${when}</small></div>`;
    sessionsList.appendChild(el);
  });

  renderDonut();
  renderLine();
}

function renderTimers(){
  timersList.innerHTML='';
  Object.values(state.categories).forEach(c=>{
    const tile=document.createElement('div');tile.className='tile';
    tile.innerHTML=`
      <div style="display:flex;align-items:center;gap:12px;flex:1">
        <div class="avatar">${c.name[0]||'‚Ä¢'}</div>
        <div class="tile-meta">
          <div class="title">${c.name}</div>
          <div class="sub">Goal: ${fmt(c.goalSeconds)}</div>
          <div class="progress"><b id="fill_${c.id}" style="width:0%"></b></div>
        </div>
      </div>
      <div class="tile-actions" id="acts_${c.id}"></div>
    `;
    timersList.appendChild(tile);

    const sec=totalForCatDate(c.id,dayKey(new Date()))+(c.running&&c.currentStart?Math.round((Date.now()-c.currentStart)/1000):0);
    const pct=Math.min(100,Math.round((sec/(c.goalSeconds||1))*100));
    const fill=document.getElementById(`fill_${c.id}`);if(fill)fill.style.width=pct+'%';

    const acts=document.getElementById(`acts_${c.id}`);acts.innerHTML='';
    const start=document.createElement('button');start.className='pill';start.textContent='Start';
    const stop=document.createElement('button');stop.className='pill';stop.textContent='Stop';
    const log=document.createElement('button');log.className='pill';log.textContent='Log';
    const del=document.createElement('button');del.className='pill';del.textContent='Del';

    if(c.running)start.disabled=true;else stop.disabled=true;

    acts.appendChild(start);acts.appendChild(stop);acts.appendChild(log);acts.appendChild(del);

    start.onclick=()=>startTimer(c.id);
    stop.onclick=()=>stopTimer(c.id,prompt('Optional note:','')||'');
    log.onclick=()=>{const m=parseFloat(prompt('Minutes to add','30'));if(m>0)addManual(c.id,m)};
    del.onclick=()=>{if(confirm('Delete?'))removeCategory(c.id)};
  });
}

function renderNotes(){
  const today=dayKey(new Date());
  notesDate.innerText=new Date().toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
  noteText.value=state.notes[today]||'';
  notesList.innerHTML='';

  const keys=Object.keys(state.notes).sort((a,b)=>b.localeCompare(a));
  keys.forEach(k=>{
    const card=document.createElement('div');card.className='note-card';
    const dateStr=new Date(k).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    const prev=state.notes[k].length>140?state.notes[k].slice(0,140)+'...':state.notes[k];
    card.innerHTML=`<div style="display:flex;justify-content:space-between"><div style="font-weight:800">${dateStr}</div><div class="muted">${k===today?'Today':''}</div></div><div style="margin-top:8px">${prev}</div>`;
    card.onclick=()=>{
      const full=prompt('Edit',state.notes[k]||'');
      if(full===null)return;
      if(full.trim()===''){if(confirm('Delete?')){delete state.notes[k];save();renderNotes();renderAll();}}
      else{state.notes[k]=full;save();renderNotes();renderAll();}
    };
    notesList.appendChild(card);
  });
}

function renderAll(){
  renderHome();renderTimers();renderNotes();
}

document.getElementById('btnExport').onclick=()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='momentum-data.json';a.click();
};
document.getElementById('btnImport').onclick=()=>{
  const inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=()=>{
    const f=inp.files[0];if(!f)return;const r=new FileReader();
    r.onload=e=>{try{const d=JSON.parse(e.target.result);if(confirm('Replace data?')){state=d;save();renderAll();}}catch(err){alert('Invalid file')}};
    r.readAsText(f);
  };inp.click();
};

document.getElementById('saveNote').onclick=()=>{
  const t=dayKey(new Date());state.notes[t]=noteText.value.trim();save();renderNotes();renderAll();alert('Saved');
};

document.getElementById('btnAdd').onclick=()=>{const n=prompt('Category','Reading');if(!n)return;const h=parseFloat(prompt('Daily goal hours','1'))||1;addCategory(n,h)};
document.getElementById('btnDefaults').onclick=()=>{ensureDefaults();save();renderAll()};
document.getElementById('btnClearToday').onclick=()=>{if(confirm('Clear today?'))clearToday()};

function setActiveTab(name){
  pageHome.style.display=name==='home'?'':'none';
  pageTimers.style.display=name==='timers'?'':'none';
  pageNotes.style.display=name==='notes'?'':'none';

  document.querySelectorAll('.nav-item').forEach(nav=>{
    const btn=nav.querySelector('.nav-btn');
    if(nav.dataset.page===name)btn.classList.add('nav-active');else btn.classList.remove('nav-active');
  });
}
document.getElementById('navHome').onclick=()=>setActiveTab('home');
document.getElementById('navTimers').onclick=()=>setActiveTab('timers');
document.getElementById('navNotes').onclick=()=>setActiveTab('notes');

let ticker=null;
function startTicker(){if(ticker)return;ticker=setInterval(()=>{renderTimers();renderHome()},900)}

(function manifest(){const m={name:"Momentum",short_name:"Momentum",start_url:".",display:"standalone",background_color:"#f6f8fc",theme_color:"#f6f8fc"};const b=new Blob([JSON.stringify(m)],{type:'application/json'});const u=URL.createObjectURL(b);const l=document.createElement('link');l.rel='manifest';l.href=u;document.head.appendChild(l)})();
(function sw(){if('serviceWorker'in navigator){const code=`const C='momentum-v1';const U=['./'];self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll(U)))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))})`;const blob=new Blob([code],{type:'application/javascript'});navigator.serviceWorker.register(URL.createObjectURL(blob))}})();

ensureDefaults();
renderAll();
startTicker();
window.addEventListener('beforeunload',save);
window._momentum_state=()=>state;
</script>

</body>
</html>                <div class="muted">Today</div>
              </div>
              <div style="display:flex;align-items:center;justify-content:center;margin-top:8px">
                <div style="width:170px;height:170px;position:relative">
                  <canvas id="donut"></canvas>
                  <div id="donutCenter" style="position:absolute;left:0;right:0;top:50%;transform:translateY(-50%);text-align:center;font-weight:800;font-size:18px;color:#071022">0m</div>
                </div>
              </div>
            </div>
          </div>

          <div class="sessions">
            <div style="margin-top:10px" class="muted">Recent sessions</div>
            <div id="sessionsList" style="margin-top:8px"></div>
          </div>
        </section>
      </main>

      <!-- TIMERS -->
      <main id="page-timers" class="page" style="display:none">
        <section class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>Timers</strong>
              <div class="muted">Start sessions and hit your daily targets</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="btnAdd">+ Add</button>
              <button class="btn" id="btnDefaults">Defaults</button>
            </div>
          </div>

          <div class="timers-list" id="timersList"></div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div class="muted">Clear today's sessions if needed</div>
            <button class="btn" id="btnClearToday">Clear Today</button>
          </div>
        </section>
      </main>

      <!-- NOTES -->
      <main id="page-notes" class="page" style="display:none">
        <section class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong id="notesTitle">Notes</strong>
              <div class="muted">Write what you achieved today</div>
            </div>
            <div class="muted" id="notesDate">‚Äî</div>
          </div>

          <div style="margin-top:12px">
            <textarea id="noteText" placeholder="What you achieve today..."></textarea>
            <div style="display:flex;justify-content:flex-end;margin-top:8px">
              <button class="btn" id="saveNote">Save</button>
            </div>
          </div>

          <div style="margin-top:14px">
            <div class="muted">Previous notes</div>
            <div class="notes-list" id="notesList"></div>
          </div>
        </section>
      </main>

      <footer style="text-align:center;color:var(--muted);font-size:12px;margin-top:6px">Offline ‚Ä¢ Single file ‚Ä¢ LocalStorage</footer>
    </div>
  </div>

  <!-- bottom nav -->
  <div class="bottom-nav">
    <div class="nav-wrap">
      <div class="nav-item" data-page="home">
        <button class="nav-btn nav-active" id="navHome">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="8" stroke="#0B69FF" stroke-width="1.6"/><circle cx="12" cy="12" r="4" fill="#0B69FF"/></svg>
          <div class="nav-label">Home</div>
        </button>
      </div>

      <div class="nav-item" data-page="timers">
        <button class="nav-btn" id="navTimers">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 7v6l4 2" stroke="#9CA3AF" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="8" stroke="#9CA3AF" stroke-width="1.6"/></svg>
          <div class="nav-label">Timers</div>
        </button>
      </div>

      <div class="nav-item" data-page="notes">
        <button class="nav-btn" id="navNotes">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="16" height="16" rx="2" stroke="#9CA3AF" stroke-width="1.6"/><path d="M8 8h8M8 12h8M8 16h5" stroke="#9CA3AF" stroke-width="1.6" stroke-linecap="round"/></svg>
          <div class="nav-label">Notes</div>
        </button>
      </div>
    </div>
  </div>

<script>
/* Momentum mobile ‚Äî rewritten charts + pages
   Chart techniques:
   - use responsive:true and maintainAspectRatio:false for mobile responsiveness (Chart.js docs). Ó®Å2Ó®Ç
   - rounded bars via borderRadius / borderSkipped (Chart.js samples). Ó®Å3Ó®Ç
   - doughnut + center text via small plugin drawing on canvas. Ó®Å4Ó®Ç
*/

/* ---------- utils ---------- */
const uid = (n=8)=>Math.random().toString(36).slice(2,2+n);
const fmt = s=>{
  if(!s) return '0m';
  if(s<60) return Math.round(s)+'s';
  const h=Math.floor(s/3600), m=Math.floor((s%3600)/60);
  if(h) return `${h}h ${m}m`;
  return `${m}m`;
};
const dayKey = d=>d.toISOString().slice(0,10);

/* ---------- state ---------- */
const KEY='momentum.mobile_v2';
let state = { categories:{}, sessions:[], notes:{}, createdAt: Date.now() };
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function load(){ try{ const raw=localStorage.getItem(KEY); if(raw) state=JSON.parse(raw); }catch(e){console.warn('load',e);} }
load();

/* ---------- defaults ---------- */
function ensureDefaults(){
  if(Object.keys(state.categories).length) return;
  addCategory('Study',6);
  addCategory('Project',4);
  addCategory('Workout',1);
  addCategory('Social',0.5);
  save();
}

/* ---------- categories ---------- */
function addCategory(name,hours=1){
  const id=uid(6);
  state.categories[id]={id,name,goalSeconds:Math.round(hours*3600),running:false,currentStart:null};
  save(); renderAll(); return id;
}
function removeCategory(id){
  delete state.categories[id];
  state.sessions = state.sessions.filter(s=>s.catId!==id);
  save(); renderAll();
}

/* ---------- timers ---------- */
function startTimer(id){
  // exclusive: stop others
  Object.values(state.categories).forEach(c=>{ if(c.running) stopTimer(c.id); });
  const c=state.categories[id]; if(!c) return;
  c.running=true; c.currentStart=Date.now(); save(); renderAll(); startTicker();
}
function stopTimer(id,note=''){
  const c=state.categories[id]; if(!c || !c.running) return;
  const start=c.currentStart||Date.now(), stop=Date.now(), dur=Math.round((stop-start)/1000);
  c.running=false; c.currentStart=null;
  state.sessions.push({id:uid(8),catId:id,start,stop,duration:dur,date:dayKey(new Date(start)),notes:note||''});
  save(); renderAll();
}
function addManual(id,minutes){
  const dur=Math.round(minutes*60); const start=Date.now()-dur*1000;
  state.sessions.push({id:uid(8),catId:id,start,stop:Date.now(),duration:dur,date:dayKey(new Date(start)),notes:'manual'});
  save(); renderAll();
}
function clearToday(){
  const t=dayKey(new Date());
  state.sessions=state.sessions.filter(s=>s.date!==t);
  if(state.notes) delete state.notes[t];
  save(); renderAll();
}

/* ---------- stats helpers ---------- */
function totalForDate(d){ return state.sessions.filter(s=>s.date===d).reduce((a,b)=>a+b.duration,0); }
function totalForCatDate(catId,d){ return state.sessions.filter(s=>s.catId===catId && s.date===d).reduce((a,b)=>a+b.duration,0); }
function lastNDays(n=7,end=new Date()){ const out=[]; for(let i=n-1;i>=0;i--){ const dt=new Date(end); dt.setDate(dt.getDate()-i); out.push(dayKey(dt)); } return out; }

/* ---------- DOM refs ---------- */
const pageHome=document.getElementById('page-home');
const pageTimers=document.getElementById('page-timers');
const pageNotes=document.getElementById('page-notes');

const todayTotalEl=document.getElementById('todayTotal');
const streakEl=document.getElementById('streak');
const chipRow=document.getElementById('chipRow');
const sessionsList=document.getElementById('sessionsList');
const barCtx=document.getElementById('barWeekly');
const donutCtx=document.getElementById('donut');
const donutCenter=document.getElementById('donutCenter');
const timersList=document.getElementById('timersList');
const notesList=document.getElementById('notesList');
const noteText=document.getElementById('noteText');
const notesDate=document.getElementById('notesDate');
const weekRangeEl=document.getElementById('weekRange');

let barChart=null, donutChart=null;

/* ---------- charts plugin: donut center text ---------- */
const DonutCenterPlugin = {
  id: 'donutCenter',
  afterDraw(chart){
    if(chart.config.type !== 'doughnut') return;
    const centerText = chart.config.options.plugins?.donutCenter?.text || '';
    const {ctx, chartArea:{top, bottom, left, right, width, height}} = chart;
    ctx.save();
    ctx.fillStyle = '#071022';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const x = left + width/2;
    const y = top + height/2;
    ctx.font = '700 16px Inter, system-ui';
    ctx.fillText(centerText, x, y);
    ctx.restore();
  }
};
Chart.register(DonutCenterPlugin);

/* ---------- render: home ---------- */
function renderHome(){
  const today=dayKey(new Date());
  const total = totalForDate(today);
  todayTotalEl.innerText = fmt(total);
  // streak (consecutive days >10min)
  const days = lastNDays(30);
  let streak=0;
  for(let i=days.length-1;i>=0;i--){
    if(totalForDate(days[i]) > 10*60) streak++; else break;
  }
  streakEl.innerText = streak + 'd';

  // chips
  chipRow.innerHTML='';
  Object.values(state.categories).forEach(c=>{
    const sec = totalForCatDate(c.id,today);
    const el = document.createElement('div'); el.className='chip';
    el.innerHTML = `<div style="font-weight:800">${c.name}</div><small>${fmt(sec)}</small>`;
    chipRow.appendChild(el);
  });

  // recent sessions
  sessionsList.innerHTML='';
  const recent = state.sessions.slice().reverse().slice(0,8);
  recent.forEach(s=>{
    const name = state.categories[s.catId] ? state.categories[s.catId].name : 'Unknown';
    const when = new Date(s.start).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const el = document.createElement('div'); el.className='session';
    el.innerHTML = `<div><strong>${name}</strong> <small>‚Ä¢ ${fmt(s.duration)}</small></div><div style="text-align:right"><small>${when}</small></div>`;
    sessionsList.appendChild(el);
  });

  // charts
  renderBarChart();
  renderDonut();
}

/* ---------- bar chart: weekly hours (minutes -> label as hours) ---------- */
function renderBarChart(){
  const days = lastNDays(7);
  weekRangeEl.innerText = `${days[0]} ‚Üí ${days[days.length-1]}`;
  const labels = days.map(d=>d.slice(5));
  const data = days.map(d=>Math.round(totalForDate(d)/60)); // minutes
  if(barChart) barChart.destroy();

  // Chart.js options: responsive & maintainAspectRatio false to behave on mobile container. Ó®Å5Ó®Ç
  barChart = new Chart(barCtx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Minutes',
        data,
        backgroundColor: '#13A45A',
        borderRadius: 8,          // rounded bars (docs sample). Ó®Å6Ó®Ç
        borderSkipped: false,
        maxBarThickness: 26
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display:false } },
      scales: {
        x: { grid:{ display:false }, ticks:{ color:'#6b7280' } },
        y: { grid:{ color:'rgba(7,16,34,0.04)' }, ticks:{ callback: v => (v/60).toFixed(0) + 'h', color:'#6b7280' } }
      },
      layout: { padding: { top:6, bottom:4 } }
    }
  });
}

/* ---------- donut chart: distribution today (center text) ---------- */
function renderDonut(){
  const today = dayKey(new Date());
  const catIds = Object.keys(state.categories);
  const labels = catIds.map(id=>state.categories[id].name);
  const data = catIds.map(id => Math.round(totalForCatDate(id,today)/60)); // minutes
  const totalMin = data.reduce((a,b)=>a+b,0);
  donutCenter.innerText = totalMin ? fmt(totalMin*60) : '0m';

  if(donutChart) donutChart.destroy();
  donutChart = new Chart(donutCtx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor: labels.map((_,i)=> i%2? '#06B6D4' : '#FF8A3D' ) }] },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      cutout: '66%',
      plugins: {
        legend: { position:'right', labels:{boxWidth:12,font:{size:12}} },
        donutCenter: { text: totalMin ? fmt(totalMin*60) : '0m' } // plugin used to draw center text
      }
    }
  });
}

/* ---------- timers page rendering ---------- */
function renderTimers(){
  timersList.innerHTML='';
  Object.values(state.categories).forEach(c=>{
    const tile = document.createElement('div'); tile.className='tile';
    tile.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;flex:1">
        <div class="avatar">${c.name[0]||'‚Ä¢'}</div>
        <div class="tile-meta">
          <div class="title">${c.name}</div>
          <div class="sub">Goal: ${fmt(c.goalSeconds)}</div>
          <div class="progress"><b id="fill_${c.id}" style="width:0%"></b></div>
        </div>
      </div>
      <div class="tile-actions" id="acts_${c.id}"></div>
    `;
    timersList.appendChild(tile);

    // progress
    const sec = totalForCatDate(c.id, dayKey(new Date())) + (c.running && c.currentStart ? Math.round((Date.now()-c.currentStart)/1000) : 0);
    const pct = Math.min(100, Math.round((sec/(c.goalSeconds||1))*100));
    const fill = document.getElementById(`fill_${c.id}`); if(fill) fill.style.width = pct + '%';

    // actions
    const acts = document.getElementById(`acts_${c.id}`);
    acts.innerHTML = '';
    const startBtn = document.createElement('button'); startBtn.className='pill'; startBtn.textContent='Start';
    const stopBtn = document.createElement('button'); stopBtn.className='pill'; stopBtn.textContent='Stop';
    const logBtn = document.createElement('button'); logBtn.className='pill'; logBtn.textContent='Log';
    const delBtn = document.createElement('button'); delBtn.className='pill'; delBtn.textContent='Del';

    if(c.running) startBtn.disabled=true; else stopBtn.disabled=true;
    acts.appendChild(startBtn); acts.appendChild(stopBtn); acts.appendChild(logBtn); acts.appendChild(delBtn);

    startBtn.onclick = ()=>startTimer(c.id);
    stopBtn.onclick = ()=>{ const note = prompt('Optional note:','')||''; stopTimer(c.id,note); };
    logBtn.onclick = ()=>{ const m = parseFloat(prompt('Minutes to add','30')); if(!isNaN(m) && m>0) addManual(c.id,m); };
    delBtn.onclick = ()=>{ if(confirm('Delete category and its sessions?')) removeCategory(c.id); };
  });
}

/* ---------- notes page ---------- */
function renderNotes(){
  const today = dayKey(new Date());
  notesDate.innerText = new Date().toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
  noteText.value = state.notes[today] || '';
  notesList.innerHTML = '';
  const keys = Object.keys(state.notes).sort((a,b)=> b.localeCompare(a));
  keys.forEach(k=>{
    const el=document.createElement('div'); el.className='note-card';
    const dd = new Date(k).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    const preview = state.notes[k].length>140 ? state.notes[k].slice(0,140)+'...' : state.notes[k];
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">${dd}</div><div class="muted" style="font-size:13px">${k===today?'Today':''}</div></div><div style="margin-top:8px;color:#071022">${preview}</div>`;
    el.onclick = ()=>{
      const full = prompt('Note for ' + dd, state.notes[k]||'');
      if(full===null) return;
      if(full.trim()===''){ if(confirm('Delete this note?')){ delete state.notes[k]; save(); renderNotes(); renderAll(); } }
      else{ state.notes[k]=full; save(); renderNotes(); renderAll(); }
    };
    notesList.appendChild(el);
  });
}

/* ---------- UI wiring ---------- */
document.getElementById('btnExport').onclick = ()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='momentum-data.json'; a.click();
};
document.getElementById('btnImport').onclick = ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json'; inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ try{ const d=JSON.parse(e.target.result); if(confirm('Replace local data with imported file?')){ state=d; save(); renderAll(); } }catch(err){ alert('Invalid JSON'); } }; r.readAsText(f); }; inp.click();
};
document.getElementById('btnAdd').onclick = ()=>{ const name=prompt('Category name','Reading'); if(!name) return; const hrs=parseFloat(prompt('Daily goal hours','1'))||1; addCategory(name,hrs); };
document.getElementById('btnDefaults').onclick = ()=>{ ensureDefaults(); save(); renderAll(); };
document.getElementById('btnClearToday').onclick = ()=>{ if(confirm('Clear today sessions and note?')) clearToday(); };
document.getElementById('saveNote').onclick = ()=>{ const t=dayKey(new Date()); state.notes = state.notes || {}; state.notes[t] = noteText.value.trim(); save(); renderNotes(); renderAll(); alert('Saved'); };

/* --- nav --- */
function setActiveTab(name){
  pageHome.style.display = name==='home' ? '' : 'none';
  pageTimers.style.display = name==='timers' ? '' : 'none';
  pageNotes.style.display = name==='notes' ? '' : 'none';
  document.querySelectorAll('.nav-item').forEach(item=>{
    const p=item.dataset.page;
    const active = p===name;
    const btn = item.querySelector('.nav-btn');
    if(active) btn.classList.add('nav-active'); else btn.classList.remove('nav-active');
    // change svg colors
    const svg = item.querySelector('svg');
    if(svg){
      svg.querySelectorAll('path,circle,rect').forEach(el=>{
        el.setAttribute('stroke', active? '#0B69FF' : '#9CA3AF');
        if(el.tagName==='circle' && active) el.setAttribute('fill','#0B69FF');
      });
    }
  });
}
document.getElementById('navHome').onclick = ()=>setActiveTab('home');
document.getElementById('navTimers').onclick = ()=>setActiveTab('timers');
document.getElementById('navNotes').onclick = ()=>setActiveTab('notes');

/* ---------- ticker ---------- */
let ticker=null;
function startTicker(){ if(ticker) return; ticker=setInterval(()=>{ renderTimers(); renderHome(); if(Math.random()<0.06) renderBarChart(); }, 900); }
function stopTicker(){ if(ticker){ clearInterval(ticker); ticker=null; } }

/* ---------- PWA manifest + SW (inline) ---------- */
(function createManifest(){ const m={name:"Momentum",short_name:"Momentum",start_url:".",display:"standalone",background_color:"#f6f8fc",theme_color:"#f6f8fc"}; const b=new Blob([JSON.stringify(m)],{type:'application/json'}); const u=URL.createObjectURL(b); let l=document.querySelector('link[rel="manifest"]'); if(!l){ l=document.createElement('link'); l.rel='manifest'; document.head.appendChild(l);} l.href=u; })();
(function registerSW(){ if('serviceWorker' in navigator){ const code=`const CACHE='momentum-mobile-v2'; const urls=['./']; self.addEventListener('install',e=>{ self.skipWaiting(); e.waitUntil(caches.open(CACHE).then(c=>c.addAll(urls)).catch(()=>{})); }); self.addEventListener('activate',e=>e.waitUntil(self.clients.claim())); self.addEventListener('fetch',e=>{ if(e.request.method!=='GET') return; e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)).catch(()=>caches.match('./'))); });`; const blob=new Blob([code],{type:'application/javascript'}); const swUrl=URL.createObjectURL(blob); navigator.serviceWorker.register(swUrl).catch(()=>console.warn('sw failed')); } })();

/* ---------- startup ---------- */
ensureDefaults();
renderAll();
startTicker();
window.addEventListener('visibilitychange', ()=>{ if(document.hidden) save(); });
window.addEventListener('beforeunload', save);

/* expose debug */
window._momentum = ()=>state;
</script>
</body>
</html>  .nav-active .nav-icon{filter: drop-shadow(0 4px 10px rgba(11,105,255,0.15))}

  /* mobile-friendly */
  @media(min-width:900px){
    .charts-grid{grid-template-columns:1fr 1fr}
  }
  @media(min-width:1100px){
    .wrap{max-width:1100px}
  }

  /* small interactions */
  button:active{transform:translateY(1px)}
  textarea{width:100%;min-height:120px;border-radius:12px;padding:12px;border:1px solid rgba(7,16,34,0.04);background:#fff}
</style>
</head>
<body>
  <div class="app">
    <div class="wrap" id="app">

      <!-- HEADER -->
      <header>
        <div class="brand">
          <div class="logo">M</div>
          <div class="title">
            <h1>Momentum</h1>
            <p>Reports ‚Ä¢ Timers ‚Ä¢ Notes</p>
          </div>
        </div>

        <div class="hdr-actions">
          <button class="btn" id="btnExport">Export</button>
          <button class="btn" id="btnImport">Import</button>
        </div>
      </header>

      <!-- PAGES -->
      <!-- HOME PAGE -->
      <main id="page-home" class="page">
        <section class="card hero">
          <div class="hero-top">
            <div>
              <div class="muted">Today's total</div>
              <div class="today-total" id="todayTotal">0m</div>
            </div>
            <div style="text-align:right">
              <div class="muted">Streak</div>
              <div style="font-weight:800" id="streak">0d</div>
            </div>
          </div>

          <div class="chip-row" id="chipRow">
            <!-- chips -->
          </div>

          <div class="charts-grid">
            <div class="chart-card card">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <strong>Weekly Hours</strong>
                <div class="muted" id="weekRange">‚Äî</div>
              </div>
              <div style="margin-top:8px">
                <canvas id="barWeekly" height="160"></canvas>
              </div>
            </div>

            <div class="chart-card card">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <strong>Distribution</strong>
                <div class="muted">Today</div>
              </div>
              <div style="margin-top:10px;display:flex;align-items:center;justify-content:center">
                <div style="width:180px;height:180px;position:relative">
                  <canvas id="donut" width="180" height="180"></canvas>
                  <div id="donutTotal" style="position:absolute;left:0;right:0;top:50%;transform:translateY(-50%);text-align:center;font-weight:800;color:#071022;font-size:18px">0m</div>
                </div>
              </div>
            </div>
          </div>

          <div class="sessions">
            <div style="margin-top:8px" class="muted">Recent sessions</div>
            <div id="sessionsList" style="margin-top:8px"></div>
          </div>
        </section>
      </main>

      <!-- TIMERS PAGE -->
      <main id="page-timers" class="page" style="display:none">
        <section class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>Timers</strong>
              <div class="muted">Start sessions and log time</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="btnAdd">+ Add</button>
              <button class="btn" id="btnDefaults">Defaults</button>
            </div>
          </div>

          <div class="timers-list" id="timersList"></div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div class="muted">Clear today's sessions if needed</div>
            <button class="btn" id="btnClearToday">Clear Today</button>
          </div>
        </section>
      </main>

      <!-- NOTES PAGE -->
      <main id="page-notes" class="page" style="display:none">
        <section class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong id="notesHeading">Notes</strong>
              <div class="muted">Write what you achieved today</div>
            </div>
            <div class="muted" id="notesDate">‚Äî</div>
          </div>

          <div style="margin-top:12px">
            <textarea id="noteText" placeholder="What you achieve today..."></textarea>
            <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" id="saveNote">Save</button></div>
          </div>

          <div style="margin-top:12px">
            <div class="muted">Previous notes</div>
            <div class="notes-list" id="notesList"></div>
          </div>
        </section>
      </main>

      <footer style="text-align:center;color:var(--muted);font-size:12px;margin-top:6px">Offline ‚Ä¢ Single file ‚Ä¢ LocalStorage</footer>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="bottom-nav">
    <div class="nav-wrap">
      <div class="nav-item" data-page="home">
        <button class="nav-btn nav-active" id="navHome">
          <!-- recording icon -->
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="8" stroke="#0B69FF" stroke-width="1.6"/><circle cx="12" cy="12" r="4" fill="#0B69FF"/></svg>
          <div class="nav-label">Home</div>
        </button>
      </div>

      <div class="nav-item" data-page="timers">
        <button class="nav-btn" id="navTimers">
          <!-- timer icon -->
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 7v6l4 2" stroke="#9CA3AF" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="8" stroke="#9CA3AF" stroke-width="1.6"/></svg>
          <div class="nav-label">Timers</div>
        </button>
      </div>

      <div class="nav-item" data-page="notes">
        <button class="nav-btn" id="navNotes">
          <!-- notes icon -->
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="16" height="16" rx="2" stroke="#9CA3AF" stroke-width="1.6"/><path d="M8 8h8M8 12h8M8 16h5" stroke="#9CA3AF" stroke-width="1.6" stroke-linecap="round"/></svg>
          <div class="nav-label">Notes</div>
        </button>
      </div>
    </div>
  </div>

<script>
/* Single-file Momentum ‚Äî multi-page, charts, notes, timers, localStorage */

/* --- utils --- */
const uid = (n=8)=>Math.random().toString(36).slice(2,2+n);
const fmt = s=>{
  if(!s) return '0s';
  if(s<60) return s+'s';
  const h=Math.floor(s/3600), m=Math.floor((s%3600)/60);
  if(h) return h+'h '+m+'m';
  return m+'m';
}
const dayKey = d=>d.toISOString().slice(0,10);

/* --- state --- */
const KEY='momentum.multi.v1';
let state = {
  categories:{}, // id:{id,name,goalSeconds,running,currentStart}
  sessions:[],   // {id,catId,start,stop,duration,date,notes}
  notes:{},      // date:text
  createdAt:Date.now()
};
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function load(){ try{ const raw=localStorage.getItem(KEY); if(raw) state=JSON.parse(raw); }catch(e){ console.warn(e); } }
load();

/* --- default cats --- */
function ensureDefaults(){
  if(Object.keys(state.categories).length) return;
  addCategory('Study',6);
  addCategory('Project',4);
  addCategory('Workout',1);
  addCategory('Social',0.5);
  save();
}

/* --- categories --- */
function addCategory(name,hours=1){
  const id=uid(6);
  state.categories[id]={id,name,goalSeconds:Math.round(hours*3600),running:false,currentStart:null};
  save(); renderAll(); return id;
}
function removeCategory(id){
  delete state.categories[id];
  state.sessions = state.sessions.filter(s=>s.catId!==id);
  save(); renderAll();
}

/* --- timers --- */
function startTimer(id){
  // exclusive
  Object.values(state.categories).forEach(c=>{ if(c.running) stopTimer(c.id); });
  const c=state.categories[id]; if(!c) return;
  c.running=true; c.currentStart=Date.now(); save(); renderAll(); startTicker();
}
function stopTimer(id,note=''){
  const c=state.categories[id]; if(!c || !c.running) return;
  const start=c.currentStart||Date.now(); const stop=Date.now();
  const dur=Math.round((stop-start)/1000);
  c.running=false; c.currentStart=null;
  state.sessions.push({id:uid(8),catId:id,start,stop,duration:dur,date:dayKey(new Date(start)),notes:note||''});
  save(); renderAll();
}
function addManual(id,minutes){
  const dur=Math.round(minutes*60); const start=Date.now()-dur*1000;
  state.sessions.push({id:uid(8),catId:id,start,stop:Date.now(),duration:dur,date:dayKey(new Date(start)),notes:'manual'});
  save(); renderAll();
}
function clearToday(){
  const t=dayKey(new Date());
  state.sessions=state.sessions.filter(s=>s.date!==t);
  if(state.notes) delete state.notes[t];
  save(); renderAll();
}

/* --- stats --- */
function totalForDate(d){ return state.sessions.filter(s=>s.date===d).reduce((a,b)=>a+b.duration,0); }
function totalForCatDate(catId,d){ return state.sessions.filter(s=>s.catId===catId && s.date===d).reduce((a,b)=>a+b.duration,0); }
function lastNDays(n=7,end=new Date()){ const out=[]; for(let i=n-1;i>=0;i--){ const dt=new Date(end); dt.setDate(dt.getDate()-i); out.push(dayKey(dt)); } return out; }

/* --- DOM refs --- */
const pageHome = document.getElementById('page-home');
const pageTimers = document.getElementById('page-timers');
const pageNotes = document.getElementById('page-notes');

const todayTotalEl = document.getElementById('todayTotal');
const streakEl = document.getElementById('streak');
const chipRow = document.getElementById('chipRow');
const sessionsList = document.getElementById('sessionsList');
const barWeeklyCtx = document.getElementById('barWeekly').getContext('2d');
const donutCtx = document.getElementById('donut').getContext('2d');
const donutTotal = document.getElementById('donutTotal');
const timersList = document.getElementById('timersList');
const notesHeading = document.getElementById('notesHeading');
const notesDate = document.getElementById('notesDate');
const noteText = document.getElementById('noteText');
const notesList = document.getElementById('notesList');
const weekRangeEl = document.getElementById('weekRange');

let barChart = null, donutChart = null;

/* --- render functions --- */
function renderAll(){
  renderHome(); renderTimers(); renderNotes();
}
function renderHome(){
  const today = dayKey(new Date());
  const tot = totalForDate(today);
  todayTotalEl.innerText = fmt(tot);
  // streak: consecutive days > 10min
  const days = lastNDays(30);
  let s=0;
  for(let i=days.length-1;i>=0;i--){ if(totalForDate(days[i])>10*60) s++; else break; }
  streakEl.innerText = s + 'd';

  // chips
  chipRow.innerHTML='';
  Object.values(state.categories).forEach(c=>{
    const sec = totalForCatDate(c.id,today);
    const d = document.createElement('div'); d.className='chip'; d.innerHTML=`<div style="font-weight:800">${c.name}</div><small>${fmt(sec)}</small>`;
    chipRow.appendChild(d);
  });

  // sessions
  sessionsList.innerHTML='';
  const recent = state.sessions.slice().reverse().slice(0,8);
  recent.forEach(s=>{
    const cat = state.categories[s.catId] ? state.categories[s.catId].name : 'Unknown';
    const when = new Date(s.start).toLocaleString();
    const el = document.createElement('div'); el.className='session';
    el.innerHTML = `<div><strong>${cat}</strong> <small>‚Ä¢ ${fmt(s.duration)}</small></div><div style="text-align:right"><small>${when}</small></div>`;
    sessionsList.appendChild(el);
  });

  // charts
  renderBarChart();
  renderDonut();
}

/* --- bar chart: weekly green bars (hours) --- */
function renderBarChart(){
  const days = lastNDays(7);
  weekRangeEl.innerText = `${days[0]} ‚Üí ${days[days.length-1]}`;
  const labels = days.map(d=>d.slice(5));
  const values = days.map(d=>Math.round(totalForDate(d)/60)); // minutes -> show as minutes
  // display as hours fractional: we'll convert minutes to hours in ticks but chart uses minutes for scale; we will label axis in hours later
  if(barChart) barChart.destroy();
  barChart = new Chart(barWeeklyCtx, {
    type:'bar',
    data:{labels, datasets:[{label:'Minutes', data: values, backgroundColor: Array(values.length).fill('#13A45A')} ]},
    options:{
      plugins:{legend:{display:false}},
      scales:{
        y:{beginAtZero:true, ticks:{callback: v => (v/60).toFixed(0)+'h'} },
        x:{grid:{display:false}}
      },
      maintainAspectRatio:false
    }
  });
}

/* --- donut chart: distribution today with orange/teal segments --- */
function renderDonut(){
  const today = dayKey(new Date());
  const cats = Object.keys(state.categories);
  const labels = cats.map(id=>state.categories[id].name);
  const data = cats.map(id=>Math.round(totalForCatDate(id,today)/60));
  const totalMin = data.reduce((a,b)=>a+b,0);
  donutTotal.innerText = totalMin ? fmt(totalMin*60) : '0m';
  if(donutChart) donutChart.destroy();
  donutChart = new Chart(donutCtx, {
    type:'doughnut',
    data:{labels, datasets:[{data, backgroundColor: labels.map((_,i)=> i%2? '#06B6D4' : '#FF8A3D' )}]},
    options:{plugins:{legend:{position:'bottom'}}, maintainAspectRatio:false, cutout: '65%'}
  });
}

/* --- timers page --- */
function renderTimers(){
  timersList.innerHTML='';
  Object.values(state.categories).forEach(c=>{
    const tile = document.createElement('div'); tile.className='tile';
    tile.innerHTML = `
      <div class="tile-left">
        <div class="avatar">${c.name[0]||'‚Ä¢'}</div>
        <div class="tile-meta">
          <div class="title">${c.name}</div>
          <div class="sub">Goal: ${fmt(c.goalSeconds)}</div>
          <div class="progress"><b id="fill_${c.id}" style="width:0%"></b></div>
        </div>
      </div>
      <div class="tile-actions" id="actions_${c.id}"></div>
    `;
    timersList.appendChild(tile);

    // fill progress
    const sec = totalForCatDate(c.id, dayKey(new Date())) + (c.running && c.currentStart ? Math.round((Date.now()-c.currentStart)/1000) : 0);
    const pct = Math.min(100, Math.round((sec/(c.goalSeconds||1))*100));
    const fill = document.getElementById(`fill_${c.id}`); if(fill) fill.style.width = pct + '%';

    // actions
    const act = document.getElementById(`actions_${c.id}`);
    act.innerHTML = '';
    const startBtn = document.createElement('button'); startBtn.className='pill'; startBtn.innerText='Start';
    const stopBtn = document.createElement('button'); stopBtn.className='pill'; stopBtn.innerText='Stop';
    const logBtn = document.createElement('button'); logBtn.className='pill ghost'; logBtn.innerText='Log';
    const delBtn = document.createElement('button'); delBtn.className='pill ghost'; delBtn.innerText='Del';
    if(c.running) startBtn.disabled=true; else stopBtn.disabled=true;
    act.appendChild(startBtn); act.appendChild(stopBtn); act.appendChild(logBtn); act.appendChild(delBtn);

    startBtn.onclick = ()=> startTimer(c.id);
    stopBtn.onclick = ()=>{ const note = prompt('Optional note:','')||''; stopTimer(c.id,note); };
    logBtn.onclick = ()=>{ const m = parseFloat(prompt('Minutes to add','30')); if(!isNaN(m) && m>0) addManual(c.id,m); };
    delBtn.onclick = ()=>{ if(confirm('Delete category and its sessions?')) removeCategory(c.id); };
  });
}

/* --- notes page --- */
function renderNotes(){
  const today = dayKey(new Date());
  const displayDate = new Date().toLocaleDateString(undefined, {year:'numeric',month:'long',day:'numeric'});
  notesHeading.innerText = 'Notes';
  notesDate.innerText = displayDate;
  noteText.value = state.notes[today] || '';
  // previous notes (descending)
  notesList.innerHTML = '';
  const keys = Object.keys(state.notes).sort((a,b)=> b.localeCompare(a)); // newest first
  keys.forEach(k=>{
    const el = document.createElement('div'); el.className='note-card';
    const dd = new Date(k).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    const preview = state.notes[k].length>140? state.notes[k].slice(0,140)+'...' : state.notes[k];
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">${dd}</div><div class="muted" style="font-size:13px">${k===today?'Today':''}</div></div><div style="margin-top:8px;color:#071022">${preview}</div>`;
    el.onclick = ()=> {
      // expand in prompt for quick edit/view
      const full = prompt('Note for '+dd, state.notes[k] || '');
      if(full===null) return;
      if(full.trim()===''){ if(confirm('Delete this note?')){ delete state.notes[k]; save(); renderNotes(); renderAll(); } }
      else{ state.notes[k]=full; save(); renderNotes(); renderAll(); }
    };
    notesList.appendChild(el);
  });
}

/* --- charts/tickers --- */
let ticker = null;
function startTicker(){ if(ticker) return; ticker = setInterval(()=>{ renderTimers(); renderHome(); if(Math.random()<0.05) renderBarChart(); }, 900); }
function stopTicker(){ if(ticker){ clearInterval(ticker); ticker=null; } }

/* --- export/import --- */
function exportJSON(){
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='momentum-data.json'; a.click();
}
function importJSON(file){
  const r=new FileReader();
  r.onload=e=>{
    try{ const d=JSON.parse(e.target.result); if(confirm('Replace local data with imported file?')){ state=d; save(); renderAll(); alert('Imported'); } }
    catch(err){ alert('Invalid JSON'); console.warn(err); }
  }; r.readAsText(file);
}

/* --- UI wiring --- */
document.getElementById('btnExport').onclick = exportJSON;
document.getElementById('btnImport').onclick = ()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json'; inp.onchange=()=>importJSON(inp.files[0]); inp.click(); };
document.getElementById('btnAdd').onclick = ()=>{ const name=prompt('Category name','Reading'); if(!name) return; const hrs=parseFloat(prompt('Daily goal hours','1'))||1; addCategory(name,hrs); };
document.getElementById('btnDefaults').onclick = ()=>{ ensureDefaults(); save(); renderAll(); };
document.getElementById('btnClearToday').onclick = ()=>{ if(confirm('Clear today sessions and note?')) clearToday(); };

document.getElementById('saveNote').onclick = ()=>{ const today=dayKey(new Date()); state.notes = state.notes || {}; state.notes[today] = noteText.value.trim(); save(); renderNotes(); renderAll(); alert('Saved'); };

/* --- navigation (tabs) --- */
function setActiveTab(name){
  pageHome.style.display = name==='home' ? '' : 'none';
  pageTimers.style.display = name==='timers' ? '' : 'none';
  pageNotes.style.display = name==='notes' ? '' : 'none';
  // nav visuals
  document.querySelectorAll('.nav-item').forEach(item=>{
    const p=item.dataset.page;
    if(p===name) item.querySelector('.nav-btn').classList.add('nav-active'); else item.querySelector('.nav-btn').classList.remove('nav-active');
    // update svg stroke color
    const svg = item.querySelector('svg');
    if(svg){
      const active = p===name;
      svg.querySelectorAll('path,circle,rect').forEach(el=> el.setAttribute('stroke', active? '#0B69FF' : '#9CA3AF') );
      svg.querySelectorAll('circle,rect').forEach(el=> { if(active && el.getAttribute('fill')) el.setAttribute('fill','#0B69FF'); });
    }
  });
}

document.getElementById('navHome').onclick = ()=> setActiveTab('home');
document.getElementById('navTimers').onclick = ()=> setActiveTab('timers');
document.getElementById('navNotes').onclick = ()=> setActiveTab('notes');

/* --- manifest + service worker for PWA --- */
(function createManifest(){
  const manifest = { name:"Momentum", short_name:"Momentum", start_url:".", display:"standalone", background_color:"#f6f8fa", theme_color:"#f6f8fa" };
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  let link = document.querySelector('link[rel="manifest"]');
  if(!link){ link = document.createElement('link'); link.rel='manifest'; document.head.appendChild(link); }
  link.href = url;
})();
(function registerSW(){
  if('serviceWorker' in navigator){
    const code = `
      const CACHE = 'momentum-multi-v1';
      const urls = ['./'];
      self.addEventListener('install', e=>{ self.skipWaiting(); e.waitUntil(caches.open(CACHE).then(c=>c.addAll(urls)).catch(()=>{})); });
      self.addEventListener('activate', e=>e.waitUntil(self.clients.claim()));
      self.addEventListener('fetch', e=>{ if(e.request.method !== 'GET') return; e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)).catch(()=>caches.match('./'))); });
    `;
    const blob = new Blob([code], {type:'application/javascript'});
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).catch(()=>console.warn('sw failed'));
  }
})();

/* --- startup --- */
ensureDefaults();
renderAll();
startTicker();
window.addEventListener('visibilitychange', ()=>{ if(document.hidden) save(); });
window.addEventListener('beforeunload', save);

/* expose state for debugging if needed */
window._momentum_state = ()=> state;
</script>
</body>
</html>
